\subsubsection*{Devices and Assets}
To manage the information from all the sensors, actuators, and elements involved in this system within the Thingsboard platform, we utilize virtual representations of 
these components through Devices and Assets. Devices represent each node virtually, while assets represent the corresponding physical elements. For our use cases, we 
distinguish between two types of nodes, each with its own device profile, and define one asset type as listed below:
\begin{itemize}
    \item PIR Node Profile. This Device Profile corresponds to nodes equipped with sensors for presence detection, periodic measurements of temperature, humidity, 
    wind, smoke, and flame detection via infrared sensors. These nodes are positioned along the perimeter of the field. The PIR Node features:
    \begin{itemize}
        \item 2 PIR Sensors.
        \item 2 Infrared Sensors.
        \item Temperature and Humidity Sensor.
        \item Soil moisture Sensor.
        \item Wind Speed Sensor.
        \item GPS Module.
    \end{itemize}
    \item Fence Node Profile. This Device Profile refers to a simpler node equipped with an accelerometer, placed on the fence surrounding the crop field to detect 
    potential unauthorized crossings. The Fence Node contains:
    \begin{itemize}
        \item Accelerometer.
    \end{itemize}
    \item Presence Asset Profile. This Asset Profile indicates real-time presence detection for each fence section. It differentiates between a presence detected on 
    a single side, multiple detections, or a possible unauthorized crossing.
\end{itemize}
For this project, and considering the specified constraints, we deployed a total of 8 devices to cover the perimeter of the crop field—4 devices for each defined Device 
Profile. Additionally, we defined 4 assets using the Presence Asset Profile type, representing the presence detected by each fence segment. \autoref{fig:NodesSchematic} provides a schematic 
representation of the nodes and assets placement.
\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{./images/8/NodesSchematic.PNG}
    \caption{Node Schema}
    \label{fig:NodesSchematic}
\end{figure}

To detect presence or crossings effectively, the PIR Node Devices are configured with relationships to two neighboring PIR Nodes and two defined assets. These relationships 
are as follows (the terms left and right are oriented outward from the crop field):
\begin{itemize}
    \item (\texttt{leftneighbour}): Links a PIR Node to the PIR Node located to its left.
    \item (\texttt{rightneighbour}): Links a PIR Node to the PIR Node located to its right.
    \item (\texttt{leftpresence}): Links a PIR Node to the Presence Asset on its left side.
    \item (\texttt{rightpresence}): Links a PIR Node to the Presence Asset on its right side.
    \item (\texttt{features}): Links a Fence Node to the Presence Asset associated with its section.
\end{itemize}
By leveraging these relationships, the system can monitor detected presences, determine which side of the field they occur on, and generate appropriate alarms accordingly. 
Therefore, the relationships for each node, based on the previous diagram, would be as indicated below:



\subsubsection*{Rule Chains}
In this project, two distinct nodes were developed, each with its specific characteristics. On one hand, we have the PIR node and on the other hand, the fence node. 
Each device profile is assigned a specific Rule Chain to analyze the data received from the node devices and trigger the corresponding alarms.


\subsubsection*{PIR Node Analyzer}
The alarms generated by this Rule Chain include:
\begin{itemize}
    \item Fire Detected.
    \item Fire Hazard.
    \item Presence Detected.
\end{itemize}

The Rule Chain first validates that all required fields are present in the incoming message. If the message format is incorrect or incomplete, an alarm is triggered 
to indicate that the incoming message cannot be processed. Once the message format is validated, the data is parsed for easier subsequent processing, producing a JSON
structure similar to the one shown in \autoref{fig:parsedJson}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{./images/8/jsonParsed.PNG}
    \caption{Parsed JSON for Rule Chain Processing}
    \label{fig:parsedJson}
\end{figure}

Fire detection relies on the value in the \texttt{fire} field. In the Check Fire node of the Rule Chain, if the \texttt{fire} field returns \texttt{true}, a critical alarm for "Fire Detected"
is triggered. If the value is \texttt{false}, the alarm is deactivated.

The "Fire Hazard" alarm is activated by evaluating the parameters for temperature, humidity, wind speed, and smoke levels. According to some studies\cite{norma303030tres}, the conditions 
for a fire hazard include:
\begin{itemize}
    \item Temperature above $30$°$C$.
    \item Relative humidity below $30\%$.
    \item Wind speeds exceeding $30 km/h$.
\end{itemize}

Additionally, a smoke concentration exceeding 200 \acrfullr{ppm} triggers the alarm. If none of these conditions are met, the alarm is deactivated.

For presence detection, four PIR nodes are placed at each vertex of the square representing the crop field. The field is divided into four zones corresponding to each side 
of the polygon. The presence detection algorithm works as follows:
\begin{itemize}
    \item If a presence is detected by a PIR sensor (indicated by 'pir\_XX\_detection', where XX can be 'left' or 'right'):
    \begin{itemize}
        \item The status of the opposite side’s neighboring node is checked.
        \item If the neighboring node also reports presence (\texttt{true}) within a timespan of 10 seconds, the "Presence Detected" alarm is triggered, and a speaker is activated.
        \item If no presence is detected on the opposite side, a lower-priority alarm is triggered, indicating presence on one side of the fence.
    \end{itemize}
    \item If no presence is detected on the initial node, all related presence alarms are deactivated. 
\end{itemize}

The pseudocode for this logic is as follows:
\lstinputlisting[caption={Presence Algorithm}, label={lst:presence}]{code/presence.c}

To implement this algorithm, relationships between the various nodes and assets were defined. Accessing values from neighboring nodes was achieved through the Change
Originator node in Thingsboard, which specifies the target node using the predefined relationships. Similarly, the originator change process is used to update related 
asset values. The full flow of the Rule Chain is illustrated in \autoref{fig:PirNodeAnalyzer}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1.4\textwidth,angle=90]{./images/8/PirNodeAnalyzer.PNG}
    \caption{PIR Node Analyzer Rule Chain FLow}
    \label{fig:PirNodeAnalyzer}
\end{figure}

\subsubsection*{Fence Node Analyzer}
This Rule Chain is designed to process messages from nodes placed on the fence to detect movements and generate alarms accordingly.  
Similar to the previous Rule Chain, it first validates that all required fields are present in the incoming message. However, since this node is simpler, the Rule 
Chain specifically generates the "Fence Trespassed" alarm based on the value of the 'acceleration\_interruption' field. The flow of this process is illustrated in \autoref{fig:FenceNodeAnalyzer}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{./images/8/FenceNodeAnalyzer.PNG}
    \caption{Fence Node Analyzer Rule Chain FLow}
    \label{fig:FenceNodeAnalyzer}
\end{figure}

\subsubsection*{Alarms}

\subsubsection*{Dashboard}